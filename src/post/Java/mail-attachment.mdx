---
title: "Playwright와 Thymeleaf를 활용하여 이메일에 첨부파일 보내기"
date: "2025-07-07"
---

## 배경
- PDF를 메일에 첨부파일 형식으로 보내는 기능을 추가하기 위해서 처음에는 `openhtmltopdf` 라이브러리를 사용했었다.
- `openhtmltopdf`는 html을 읽어서 파싱하여 PDF로 변환해주는 라이브러리지만 CSS 호환성이 떨어지고, 실제 브라우저 렌더링과 차이가 발생하여 고민 중, `playwright`를 발견했다.
- `playwright`는 화면을 사진처럼 찍어서 PDF로 변환해주는 라이브러리이며, `Bootstrap`, `tailwind` 등의 UI 라이브러리와 CSS 걱정이 필요 없다는 장점을 가지게 되어 채택하게 되었다.
- 물론 서버에서 작동되는 것이기 때문에 서버에 부담을 줄 순 있지만 많은 양을 한번에 작업하는 것도 아니고 간단한 Table 형식을 PDF로 변환하는 것이기 때문에 큰 고려사항은 아니라고 판단했다.

## 구현 과정
- 기존에 내가 구현한 방식은 아래와 같다
1. 동적으로 데이터를 가져옴 (Mapper)
2. 데이터를 Thymeleaf context에 추가하여 `html`을 `String` 형태로 반환한다.
3. 반환한 html String 문자열을 `openhtmltopdf` 라이브러리를 활용하여 `byte[]` 형식으로 반환한다.
4. 해당 `byte[]` 형식으로 변환한 문자열을 `addAttachment`로 첨부하여 보내면 PDF 파일을 포함한 메일을 보낼 수 있다.

- 하지만, 앞에서 서술했다 시피 브라우저에 렌더링 된 화면과 실제 첨부된 PDF 파일이 확연하게 다르게 출력됐고, CSS의 불편함에 유지보수도 어려워져 결국엔 `playwright`를 사용하기로 했다.
- 그래서 수정 한 방법은 아래와 같다.
1. Thymeleaf View Templates을 반환하는 컨트롤러를 만든다. (동적으로 데이터를 가져와서 원하는 형태의 Thymeleaf 템플릿을 만든다.)
이는 유지보수시 로컬 주소에서 직접 화면을 보면서 수정할 수 있고, 해당 화면이 PDF로 찍혀서 나오는 것이기 때문에 매우 편리하다.
- `ViewTestController`
```java
@Controller
@RequestMapping("/before-pdf")
@RequiredArgsConstructor
public class ViewTestController {

	private final OrderOutService orderOutService;

	@GetMapping("/attachment")
	public String transOutInvoice(@RequestParam String Parameters, Model model) {

		List<Map<String, Object>> Data = xxxService.xxxMapper(Parameters)

		model.addAttribute("printData", Data);
		return "attachmentHtml";
	}
}
```
2. playwright 라이브러리를 활용, url과 cookie (session)을 파라미터로 받아 PDF로 변환하는 로직을 구현한다.
- 데이터를 가져올때 세션 값이 필요하기 때문에 cookie를 context에 넣어주고, url로 이동하여 PDF로 변환하는 흐름이다. -> `byte[]` 형태로 반환하는 것을 잊지말자.
- `PlaywrightPdfService`
```java
@Service
public class PlaywrightPdfService {

	public byte[] generatePdfFromUrl(String url, Map<String, String> cookies) throws Exception {
		try (Playwright playwright = Playwright.create()) {
			Browser browser = playwright.chromium().launch(new BrowserType.LaunchOptions().setHeadless(true));
			BrowserContext context = browser.newContext();

			if (cookies != null && !cookies.isEmpty()) {
				List<Cookie> cookieList = new ArrayList<>();
				for (Map.Entry<String, String> entry : cookies.entrySet()) {
					cookieList.add(new Cookie(entry.getKey(), entry.getValue())
						.setDomain("localhost")
						.setPath("/"));
				}

				context.addCookies(cookieList);
			}

			Page page = context.newPage();
			page.navigate(url);

			byte[] pdfBytes = page.pdf(new Page.PdfOptions()
				.setFormat("A4")
				.setPrintBackground(true)
			);

			browser.close();
			return pdfBytes;
		}
	}
}
```
3. 변환한 바이트 배열을 Email 첨부파일에 추가하여 보낸다.

## 후기
- 자세한 코드는 깃허브에 업로드할 예정이니 해당 코드를 참고하길 바란다.
- 진짜 2-3일 동안 방법을 찾기 위해 많이 노력했던 것 같다, 물론 앞에 서술한 방법 말고도 다른 방법은 존재한다. <del>단지 내가 모를뿐....</del>
- 서술하지 않았지만 `openhtmltopdf`, `playwright` 외에도 프론트(클라이언트) 단에서 PDF로 변환하는 라이브러리도 존재해서 시도는 해봤으나 PDF 변환이 제대로 되질 않고 같은 문제점이 반복되는 바람에 지푸라기라도 잡는 심정으로 찾았는데 구현하게 되어서 너무 좋았다.
- 나와 같은 어려움을 겪는다면 한 번 참고해보는 궛도 좋을 것 같다.